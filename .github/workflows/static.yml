name: Static Analysis

on:
  pull_request:
    branches:
      - main
      - main-*

jobs:
  static-analysis:
    name: Static Analysis
    runs-on: self-hosted
    container:
      image: ubuntu:24.04
    strategy:
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install packages
        run: |
          apt-get update
          apt-get install -y sudo build-essential curl openjdk-11-jdk unzip git

      - name: Configure git safe directory
        run: git config --global --add safe.directory '*'

      - name: Install nix
        uses: cachix/install-nix-action@v27
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
          nix_path: nixpkgs=channel:nixos-24.05
          enable_kvm: false

      - uses: cachix/cachix-action@v15
        env:
          USER: root
        with:
          name: holochain-ci

      - name: Make Static
        run: |
          nix develop --no-update-lock-file --command bash -c "CHK_SQL_FMT=1 make static"
